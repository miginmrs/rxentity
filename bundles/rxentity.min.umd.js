!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("rxjs"),require("rxjs/operators")):"function"==typeof define&&define.amd?define(["rxjs","rxjs/operators"],e):"object"==typeof exports?exports.rxentity=e(require("rxjs"),require("rxjs/operators")):t.rxentity=e(t.rxjs,t.rxjs.operators)}(window,(function(t,e){return function(t){var e={};function r(n){if(e[n])return e[n].exports;var i=e[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)r.d(n,i,function(e){return t[e]}.bind(null,i));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=20)}([function(e,r){e.exports=t},function(t,e,r){"use strict";var n,i=this&&this.__extends||(n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});Object.defineProperty(e,"__esModule",{value:!0});var s=r(11),o=r(12),u=r(21),c=r(14),a=r(5),l=r(6),p=function(t){function e(r,n,i){var s=t.call(this)||this;switch(s.syncErrorValue=null,s.syncErrorThrown=!1,s.syncErrorThrowable=!1,s.isStopped=!1,arguments.length){case 0:s.destination=o.empty;break;case 1:if(!r){s.destination=o.empty;break}if("object"==typeof r){r instanceof e?(s.syncErrorThrowable=r.syncErrorThrowable,s.destination=r,r.add(s)):(s.syncErrorThrowable=!0,s.destination=new h(s,r));break}default:s.syncErrorThrowable=!0,s.destination=new h(s,r,n,i)}return s}return i(e,t),e.prototype[c.rxSubscriber]=function(){return this},e.create=function(t,r,n){var i=new e(t,r,n);return i.syncErrorThrowable=!1,i},e.prototype.next=function(t){this.isStopped||this._next(t)},e.prototype.error=function(t){this.isStopped||(this.isStopped=!0,this._error(t))},e.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,t.prototype.unsubscribe.call(this))},e.prototype._next=function(t){this.destination.next(t)},e.prototype._error=function(t){this.destination.error(t),this.unsubscribe()},e.prototype._complete=function(){this.destination.complete(),this.unsubscribe()},e.prototype._unsubscribeAndRecycle=function(){var t=this._parentOrParents;return this._parentOrParents=null,this.unsubscribe(),this.closed=!1,this.isStopped=!1,this._parentOrParents=t,this},e}(u.Subscription);e.Subscriber=p;var h=function(t){function e(e,r,n,i){var u,c=t.call(this)||this;c._parentSubscriber=e;var a=c;return s.isFunction(r)?u=r:r&&(u=r.next,n=r.error,i=r.complete,r!==o.empty&&(a=Object.create(r),s.isFunction(a.unsubscribe)&&c.add(a.unsubscribe.bind(a)),a.unsubscribe=c.unsubscribe.bind(c))),c._context=a,c._next=u,c._error=n,c._complete=i,c}return i(e,t),e.prototype.next=function(t){if(!this.isStopped&&this._next){var e=this._parentSubscriber;a.config.useDeprecatedSynchronousErrorHandling&&e.syncErrorThrowable?this.__tryOrSetError(e,this._next,t)&&this.unsubscribe():this.__tryOrUnsub(this._next,t)}},e.prototype.error=function(t){if(!this.isStopped){var e=this._parentSubscriber,r=a.config.useDeprecatedSynchronousErrorHandling;if(this._error)r&&e.syncErrorThrowable?(this.__tryOrSetError(e,this._error,t),this.unsubscribe()):(this.__tryOrUnsub(this._error,t),this.unsubscribe());else if(e.syncErrorThrowable)r?(e.syncErrorValue=t,e.syncErrorThrown=!0):l.hostReportError(t),this.unsubscribe();else{if(this.unsubscribe(),r)throw t;l.hostReportError(t)}}},e.prototype.complete=function(){var t=this;if(!this.isStopped){var e=this._parentSubscriber;if(this._complete){var r=function(){return t._complete.call(t._context)};a.config.useDeprecatedSynchronousErrorHandling&&e.syncErrorThrowable?(this.__tryOrSetError(e,r),this.unsubscribe()):(this.__tryOrUnsub(r),this.unsubscribe())}else this.unsubscribe()}},e.prototype.__tryOrUnsub=function(t,e){try{t.call(this._context,e)}catch(t){if(this.unsubscribe(),a.config.useDeprecatedSynchronousErrorHandling)throw t;l.hostReportError(t)}},e.prototype.__tryOrSetError=function(t,e,r){if(!a.config.useDeprecatedSynchronousErrorHandling)throw new Error("bad call");try{e.call(this._context,r)}catch(e){return a.config.useDeprecatedSynchronousErrorHandling?(t.syncErrorValue=e,t.syncErrorThrown=!0,!0):(l.hostReportError(e),!0)}return!1},e.prototype._unsubscribe=function(){var t=this._parentSubscriber;this._context=null,this._parentSubscriber=null,t.unsubscribe()},e}(p);e.SafeSubscriber=h},function(t,r){t.exports=e},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.EntityAbstract=void 0;const n=r(4);e.EntityAbstract=class{constructor(){this.update=t=>{const e=this.rx;Object.keys(t).forEach(r=>{e(r).next(t[r])})},this.rewind=t=>{},this.setParent=()=>{},this.levelOf=t=>n.of(0)}get snapshot(){const t={},e=this.rx;for(const r of Object.keys(this.rxMap))t[r]=e(r).value;return t}}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.fromPromise=e.pipe=e.combine=e.altern=e.distinct=e.map=e.of=void 0;const n=r(0),i=r(2),s=r(17);e.of=t=>Object.assign(n.of(t),{value:t}),e.map=(t,e)=>Object.defineProperty(t.pipe(i.map(e)),"value",{get:()=>e(t.value)}),e.distinct=(t,e)=>Object.defineProperty(t.pipe(i.distinctUntilChanged(e)),"value",{get:()=>t.value}),e.altern=(t,e)=>Object.defineProperty(t.pipe(s.alternMap(e)),"value",{get:()=>e(t.value).value}),e.combine=t=>Object.defineProperty(n.combineLatest(t),"value",{get:()=>t.map(t=>t.value)}),e.pipe=(t,e)=>Object.defineProperty(t.pipe(e),"value",{get:()=>t.value}),e.fromPromise=(t,e)=>new n.Observable(r=>{let n=!1;return r.next(e),t.then(t=>{n||r.next(e=t),r.complete()},t=>r.error(t)),()=>{n=!0}})},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=!1;e.config={Promise:void 0,set useDeprecatedSynchronousErrorHandling(t){if(t){var e=new Error;console.warn("DEPRECATED! RxJS was set to use deprecated synchronous error handling behavior by code at: \n"+e.stack)}else n&&console.log("RxJS: Back to a better error behavior. Thank you. <3");n=t},get useDeprecatedSynchronousErrorHandling(){return n}}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.hostReportError=function(t){setTimeout((function(){throw t}),0)}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.observable="function"==typeof Symbol&&Symbol.observable||"@@observable"},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Keys=e.guard=e.asAsync=e.wait=e.runit=void 0,e.runit=(t,e)=>{const r=(...n)=>{const i=n.length?t.next(n[0]):t.next();return i.done?e.resolve(i.value):e.resolve(i.value).then(r)};return r()},e.wait=function*(t){return yield t},e.asAsync=function(t,r,n){return(...i)=>e.runit(t.call(n,...i),r)},e.guard=(t,e)=>e;e.Keys=class{constructor(t){this.keys=Object.keys(t)}mapTo(t){const e={};return this.keys.forEach((r,n)=>e[r]=t(r,n)),e}asyncMapTo(t,e){const r={};return e.all(this.keys.map(e=>t(e).then(t=>r[e]=t))).then(()=>r)}}},function(t,e,r){"use strict";var n,i=this&&this.__extends||(n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});Object.defineProperty(e,"__esModule",{value:!0});var s=function(t){function e(e,r,n){var i=t.call(this)||this;return i.parent=e,i.outerValue=r,i.outerIndex=n,i.index=0,i}return i(e,t),e.prototype._next=function(t){this.parent.notifyNext(this.outerValue,t,this.outerIndex,this.index++,this)},e.prototype._error=function(t){this.parent.notifyError(t,this),this.unsubscribe()},e.prototype._complete=function(){this.parent.notifyComplete(this),this.unsubscribe()},e}(r(1).Subscriber);e.InnerSubscriber=s},function(t,e,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(t,e,r,n){void 0===n&&(n=r),Object.defineProperty(t,n,{enumerable:!0,get:function(){return e[r]}})}:function(t,e,r,n){void 0===n&&(n=r),t[n]=e[r]}),i=this&&this.__exportStar||function(t,e){for(var r in t)"default"===r||e.hasOwnProperty(r)||n(e,t,r)};Object.defineProperty(e,"__esModule",{value:!0}),i(r(3),e),i(r(36),e),i(r(37),e),i(r(16),e)},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.isFunction=function(t){return"function"==typeof t}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=r(5),i=r(6);e.empty={closed:!0,next:function(t){},error:function(t){if(n.config.useDeprecatedSynchronousErrorHandling)throw t;i.hostReportError(t)},complete:function(){}}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.isObject=function(t){return null!==t&&"object"==typeof t}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.rxSubscriber="function"==typeof Symbol?Symbol("rxSubscriber"):"@@rxSubscriber_"+Math.random(),e.$$rxSubscriber=e.rxSubscriber},function(t,e,r){"use strict";function n(){return"function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator"}Object.defineProperty(e,"__esModule",{value:!0}),e.getSymbolIterator=n,e.iterator=n(),e.$$iterator=e.iterator},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.$local=e.$snapshot=e.$update=e.$rewind=e.$levelOf=e.$rxMap=e.$rx=e.toEntity=e.entityFlow=e.getEntity=void 0;const n=r(17),i=new WeakMap;function s(t){if(t)return i.get(t)}e.getEntity=s;const o=(t,e)=>t.pipe(n.alternMap(t=>s(t).rx(e)));e.entityFlow=(t,e)=>new Proxy({},{get:(r,n)=>"observable"===n?t:"field"===n?e||(e=new Proxy({},{get:(e,r)=>o(t,r)})):o(t,n)}),e.toEntity=t=>{const e=new Proxy(Object.prototype,{get:(e,r)=>t.rx(r),ownKeys:()=>Object.keys(t.rxMap)});return i.set(e,t),e},e.$rx=(t,e)=>s(t).rx(e),e.$rxMap=t=>s(t).rxMap,e.$levelOf=(t,e)=>s(t).levelOf(e),e.$rewind=(t,e)=>s(t).rewind(e),e.$update=(t,e)=>s(t).update(e),e.$snapshot=t=>s(t).snapshot,e.$local=t=>s(t).local},function(t,e,r){"use strict";r.r(e),r.d(e,"alternMap",(function(){return c}));var n=r(0),i=r(2),s=r(18),o=r(9),u=r(19);function c(t,e,r){return"function"==typeof r?s=>s.pipe(c((e,s)=>Object(n.from)(t(e,s)).pipe(Object(i.map)((t,n)=>r(e,t,s,n))),e)):r=>r.lift(new a(t,e||{}))}class a{constructor(t,e){this.project=t,this.options=e}call(t,e){return e.subscribe(new l(t,this.project,this.options))}}class l extends s.OuterSubscriber{constructor(t,e,r){super(t),this.project=e,this.options=r,this.index=0}_next(t){let e;const r=this.index++;try{e=this.project(t,r)}catch(t){return void this.destination.error(t)}this._innerSub(e,t,r)}_innerSub(t,e,r){const n=this.innerSubscription,i=new o.InnerSubscriber(this,e,r),s=this.destination;s.add(i),this.innerSubscription=Object(u.subscribeToResult)(this,t,void 0,void 0,i),this.innerSubscription!==i&&s.add(this.innerSubscription),n&&n.unsubscribe()}_complete(){const{innerSubscription:t}=this;(!t||t.closed||this.options.completeWithSource)&&super._complete(),this.unsubscribe()}_unsubscribe(){this.innerSubscription=null}notifyComplete(t){this.destination.remove(t),this.innerSubscription=null,(this.isStopped||this.options.completeWithInner)&&super._complete()}notifyNext(t,e,r,n,i){this.destination.next(e)}}},function(t,e,r){"use strict";var n,i=this&&this.__extends||(n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});Object.defineProperty(e,"__esModule",{value:!0});var s=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.notifyNext=function(t,e,r,n,i){this.destination.next(e)},e.prototype.notifyError=function(t,e){this.destination.error(t)},e.prototype.notifyComplete=function(t){this.destination.complete()},e}(r(1).Subscriber);e.OuterSubscriber=s},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=r(9),i=r(24),s=r(31);e.subscribeToResult=function(t,e,r,o,u){if(void 0===u&&(u=new n.InnerSubscriber(t,r,o)),!u.closed)return e instanceof s.Observable?e.subscribe(u):i.subscribeTo(e)(u)}},function(t,e,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(t,e,r,n){void 0===n&&(n=r),Object.defineProperty(t,n,{enumerable:!0,get:function(){return e[r]}})}:function(t,e,r,n){void 0===n&&(n=r),t[n]=e[r]}),i=this&&this.__exportStar||function(t,e){for(var r in t)"default"===r||e.hasOwnProperty(r)||n(e,t,r)};Object.defineProperty(e,"__esModule",{value:!0}),i(r(10),e),i(r(38),e),i(r(8),e),i(r(41),e),i(r(4),e)},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=r(22),i=r(13),s=r(11),o=r(23),u=function(){function t(t){this.closed=!1,this._parentOrParents=null,this._subscriptions=null,t&&(this._ctorUnsubscribe=!0,this._unsubscribe=t)}var e;return t.prototype.unsubscribe=function(){var e;if(!this.closed){var r=this._parentOrParents,u=this._ctorUnsubscribe,a=this._unsubscribe,l=this._subscriptions;if(this.closed=!0,this._parentOrParents=null,this._subscriptions=null,r instanceof t)r.remove(this);else if(null!==r)for(var p=0;p<r.length;++p){r[p].remove(this)}if(s.isFunction(a)){u&&(this._unsubscribe=void 0);try{a.call(this)}catch(t){e=t instanceof o.UnsubscriptionError?c(t.errors):[t]}}if(n.isArray(l)){p=-1;for(var h=l.length;++p<h;){var b=l[p];if(i.isObject(b))try{b.unsubscribe()}catch(t){e=e||[],t instanceof o.UnsubscriptionError?e=e.concat(c(t.errors)):e.push(t)}}}if(e)throw new o.UnsubscriptionError(e)}},t.prototype.add=function(e){var r=e;if(!e)return t.EMPTY;switch(typeof e){case"function":r=new t(e);case"object":if(r===this||r.closed||"function"!=typeof r.unsubscribe)return r;if(this.closed)return r.unsubscribe(),r;if(!(r instanceof t)){var n=r;(r=new t)._subscriptions=[n]}break;default:throw new Error("unrecognized teardown "+e+" added to Subscription.")}var i=r._parentOrParents;if(null===i)r._parentOrParents=this;else if(i instanceof t){if(i===this)return r;r._parentOrParents=[i,this]}else{if(-1!==i.indexOf(this))return r;i.push(this)}var s=this._subscriptions;return null===s?this._subscriptions=[r]:s.push(r),r},t.prototype.remove=function(t){var e=this._subscriptions;if(e){var r=e.indexOf(t);-1!==r&&e.splice(r,1)}},t.EMPTY=((e=new t).closed=!0,e),t}();function c(t){return t.reduce((function(t,e){return t.concat(e instanceof o.UnsubscriptionError?e.errors:e)}),[])}e.Subscription=u},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.isArray=Array.isArray||function(t){return t&&"number"==typeof t.length}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){return Error.call(this),this.message=t?t.length+" errors occurred during unsubscription:\n"+t.map((function(t,e){return e+1+") "+t.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=t,this}return t.prototype=Object.create(Error.prototype),t}();e.UnsubscriptionError=n},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=r(25),i=r(26),s=r(27),o=r(28),u=r(29),c=r(30),a=r(13),l=r(15),p=r(7);e.subscribeTo=function(t){if(t&&"function"==typeof t[p.observable])return o.subscribeToObservable(t);if(u.isArrayLike(t))return n.subscribeToArray(t);if(c.isPromise(t))return i.subscribeToPromise(t);if(t&&"function"==typeof t[l.iterator])return s.subscribeToIterable(t);var e=a.isObject(t)?"an invalid object":"'"+t+"'";throw new TypeError("You provided "+e+" where a stream was expected. You can provide an Observable, Promise, Array, or Iterable.")}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.subscribeToArray=function(t){return function(e){for(var r=0,n=t.length;r<n&&!e.closed;r++)e.next(t[r]);e.complete()}}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=r(6);e.subscribeToPromise=function(t){return function(e){return t.then((function(t){e.closed||(e.next(t),e.complete())}),(function(t){return e.error(t)})).then(null,n.hostReportError),e}}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=r(15);e.subscribeToIterable=function(t){return function(e){for(var r=t[n.iterator]();;){var i=void 0;try{i=r.next()}catch(t){return e.error(t),e}if(i.done){e.complete();break}if(e.next(i.value),e.closed)break}return"function"==typeof r.return&&e.add((function(){r.return&&r.return()})),e}}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=r(7);e.subscribeToObservable=function(t){return function(e){var r=t[n.observable]();if("function"!=typeof r.subscribe)throw new TypeError("Provided object does not correctly implement Symbol.observable");return r.subscribe(e)}}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.isArrayLike=function(t){return t&&"number"==typeof t.length&&"function"!=typeof t}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.isPromise=function(t){return!!t&&"function"!=typeof t.subscribe&&"function"==typeof t.then}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=r(32),i=r(33),s=r(7),o=r(34),u=r(5),c=function(){function t(t){this._isScalar=!1,t&&(this._subscribe=t)}return t.prototype.lift=function(e){var r=new t;return r.source=this,r.operator=e,r},t.prototype.subscribe=function(t,e,r){var n=this.operator,s=i.toSubscriber(t,e,r);if(n?s.add(n.call(s,this.source)):s.add(this.source||u.config.useDeprecatedSynchronousErrorHandling&&!s.syncErrorThrowable?this._subscribe(s):this._trySubscribe(s)),u.config.useDeprecatedSynchronousErrorHandling&&s.syncErrorThrowable&&(s.syncErrorThrowable=!1,s.syncErrorThrown))throw s.syncErrorValue;return s},t.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){u.config.useDeprecatedSynchronousErrorHandling&&(t.syncErrorThrown=!0,t.syncErrorValue=e),n.canReportError(t)?t.error(e):console.warn(e)}},t.prototype.forEach=function(t,e){var r=this;return new(e=a(e))((function(e,n){var i;i=r.subscribe((function(e){try{t(e)}catch(t){n(t),i&&i.unsubscribe()}}),n,e)}))},t.prototype._subscribe=function(t){var e=this.source;return e&&e.subscribe(t)},t.prototype[s.observable]=function(){return this},t.prototype.pipe=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return 0===t.length?this:o.pipeFromArray(t)(this)},t.prototype.toPromise=function(t){var e=this;return new(t=a(t))((function(t,r){var n;e.subscribe((function(t){return n=t}),(function(t){return r(t)}),(function(){return t(n)}))}))},t.create=function(e){return new t(e)},t}();function a(t){if(t||(t=u.config.Promise||Promise),!t)throw new Error("no Promise impl found");return t}e.Observable=c},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=r(1);e.canReportError=function(t){for(;t;){var e=t,r=e.closed,i=e.destination,s=e.isStopped;if(r||s)return!1;t=i&&i instanceof n.Subscriber?i:null}return!0}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=r(1),i=r(14),s=r(12);e.toSubscriber=function(t,e,r){if(t){if(t instanceof n.Subscriber)return t;if(t[i.rxSubscriber])return t[i.rxSubscriber]()}return t||e||r?new n.Subscriber(t,e,r):new n.Subscriber(s.empty)}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=r(35);function i(t){return 0===t.length?n.identity:1===t.length?t[0]:function(e){return t.reduce((function(t,e){return e(t)}),e)}}e.pipe=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return i(t)},e.pipeFromArray=i},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.identity=function(t){return t}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ChildEntityImpl=void 0;const n=r(0),i=r(3),s=r(4),o=r(16),u=r(8);class c extends i.EntityAbstract{constructor(t){super(),this.rx=t=>this.rxMap[t]||(this.rxMap[t]=this.createRx(t)),this.rxSource=t=>this.rxSourceMap[t]||(this.rxSourceMap[t]=new n.BehaviorSubject(this._parent?o.$rx(this._parent,t):new n.BehaviorSubject(void 0))),this._parent=void 0,this.setParent=t=>{const e=this.parent;this._parent=t;const r=this.rxSourceMap;t&&Object.keys(r).forEach(e=>{void 0===r[e].value&&r[e].next(o.$rx(t,e))}),e&&Object.keys(o.$rxMap(e)).forEach(i=>{var s;(null===(s=r[i])||void 0===s?void 0:s.value)===o.$rxMap(e)[i]&&(t?r[i].next(o.$rx(t,i)):r[i].next(new n.BehaviorSubject(o.$rxMap(e)[i].value)))})},this.rewind=t=>{const e=this._parent;e&&(t?[t]:Object.keys(this.rxSourceMap)).forEach(t=>this.rxSource(t).next(o.$rx(e,t)))},this.levelOf=t=>s.altern(this.rxSource(t),e=>{var r;return e===(null===(r=this._parent)||void 0===r?void 0:r[t])?s.map(o.$levelOf(this._parent,t),t=>t+1):s.of(0)});const e=this.rxMap={},r=this.rxSourceMap={};let i;if(t.ready){const{data:e,parent:s}=t;this._parent=s,i=Object.keys(o.$rxMap(s)),i.forEach(t=>{const i=u.guard(t,t in e)?new n.BehaviorSubject(e[t]):o.$rx(s,t);r[t]=new n.BehaviorSubject(i)})}else{const{data:e,parentPromise:s}=t;i=Object.keys(e),s.then(this.setParent),i.forEach(t=>{r[t]=new n.BehaviorSubject(new n.BehaviorSubject(e[t]))})}i.forEach(t=>e[t]=this.createRx(t))}createRx(t){const e=this.rxSource(t);return Object.assign(s.altern(e,n.identity),{next:r=>this._parent&&e.value===o.$rx(this._parent,t)?e.next(new n.BehaviorSubject(r)):e.value.next(r)})}get parent(){return this._parent}get local(){if(!this._parent)return this.snapshot;const t=this._parent,e={},r=this.rxSourceMap;for(const n of Object.keys(r)){const i=r[n].value;i!==o.$rxMap(t)[n]&&(e[n]=i.value)}return e}}e.ChildEntityImpl=c},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.EntityImpl=void 0;const n=r(0),i=r(3);class s extends i.EntityAbstract{constructor(t){super(),this.rx=t=>this.rxMap[t]||(this.rxMap[t]=new n.BehaviorSubject(void 0));const e=this.rxMap={};Object.keys(t).forEach(r=>{e[r]=new n.BehaviorSubject(t[r])})}get local(){return this.snapshot}}e.EntityImpl=s},function(t,e,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(t,e,r,n){void 0===n&&(n=r),Object.defineProperty(t,n,{enumerable:!0,get:function(){return e[r]}})}:function(t,e,r,n){void 0===n&&(n=r),t[n]=e[r]}),i=this&&this.__exportStar||function(t,e){for(var r in t)"default"===r||e.hasOwnProperty(r)||n(e,t,r)};Object.defineProperty(e,"__esModule",{value:!0}),i(r(39),e),i(r(40),e)},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.StoredList=void 0;const n=r(0),i=r(2),s=r(8);e.StoredList=class{constructor(t){this.list=null,this.subscriber=null,this.donePromises=[],this.parentSubscriber=()=>new this.promiseCtr((t,e)=>{var r;this.parentSubsctiption=null===(r=this.parent)||void 0===r?void 0:r.entities.subscribe(async r=>{var n,i;const s=this.key,o=r.list.map(t=>this.keys.mapTo(e=>this.stores[e].get(this.keyofEntity(e,t[e])))),u=new Set(null===(n=this.list)||void 0===n?void 0:n.data.map(t=>t.entity[s])),c=await this.toPromise(o),a=c.filter(t=>!u.has(t.entity[s])).map(t=>this.keys.mapTo(e=>this.keyofEntity(e,t.entity[e]))),l=await this.toPromise(a.map(t=>this.keys.mapTo(e=>this.stores[e].get(t[e]))));if(c.forEach(t=>t.subscription.unsubscribe()),!this.list)return e();const p=this.merge(s,this.list.data,l);return this.list={data:p,status:this._status(this.list.status,r.status)},null===(i=this.subscriber)||void 0===i||i.next({list:this.list.data.map(({entity:t})=>t),status:this.list.status}),t(this.list.status)})}),this.entities=new n.Observable(t=>(console.log("+++ subscribing",this.stores),this.list={data:[],status:void 0},this.subscriber=t,this.reload(),()=>{var t,e;null===(t=this.parentSubsctiption)||void 0===t||t.unsubscribe(),this.parentSubsctiption=void 0,this.subscriber=null,null===(e=this.list)||void 0===e||e.data.forEach(t=>t.subscription.unsubscribe()),this.list=null,console.log("xxx unsubscribed",this.stores)})).pipe(i.shareReplay({bufferSize:1,refCount:!0})),this._exec=(t,e,r,n)=>s.asAsync((function*(){var i,o;let u=[];try{if(!this._setDone(t,u,this.list))return yield*s.wait(u[0]);const c=t?this.list.data:[];[r,n]=[r||(null===(i=c[0])||void 0===i?void 0:i.entity),n||(null===(o=c[c.length-1])||void 0===o?void 0:o.entity)];const a=yield*s.wait(this.retrieve(r,n,e));if(!this._setDone(t,u,this.list))return yield*s.wait(u[0]);const l=yield*s.wait(this._populate(a.data));if(!this._setDone(t,u,this.list))return yield*s.wait(u[0]);if(t||this.list.data.forEach(t=>t.subscription.unsubscribe()),this.list={data:c.concat(l),status:a.done},void 0!==a.done||!this.parent)return this.subscriber.next({list:this.list.data.map(t=>t.entity),status:this.list.status}),a.done;try{return yield*s.wait(this.parentSubsctiption?this.parent.exec(t,null):this.parentSubscriber())}catch(t){return!0}}catch(e){if(!this._setDone(t,u,this.list))return yield*s.wait(u[0]);if(this.list.status=null,!this.parent)throw e;try{const r=yield*s.wait(this.parentSubsctiption?this.parent.exec(t,e):this.parentSubscriber());return this._status(null,r)}catch(t){return!0}}finally{this.donePromises[t]=void 0}}),this.promiseCtr,this)();const{key:e,merge:r,retrieve:o,parent:u,keyof:c,keyofEntity:a,stores:l,promiseCtr:p}=t;this.keyof=c,this.keyofEntity=a,this.stores=l,this.keys=new s.Keys(l),this.retrieve=o,this.key=e,this.merge=r,this.parent=u,this.promiseCtr=p}add(t){var e;const r=this.key,i=this.keyofEntity(r,t[r]);if(null===this.list||this.list.data.find(t=>this.keyofEntity(r,t.entity[r])===i))return;const o=new n.Subscription,u=this.stores;new s.Keys(t).keys.forEach(t=>{o.add(u[t].get(i).observable.subscribe())}),this.list={data:[{entity:t,subscription:o},...this.list.data],status:this.list.status},null===(e=this.subscriber)||void 0===e||e.next({list:this.list.data.map(t=>t.entity),status:this.list.status})}remove(t){var e;if(null===this.list)return;const r=this.list.data.findIndex(e=>e.entity===t);if(-1!==r){const t=this.list;t.data[r].subscription.unsubscribe(),t.data.splice(r,1),null===(e=this.subscriber)||void 0===e||e.next({list:t.data.map(t=>t.entity),status:t.status})}}toPromise(t){return this.promiseCtr.all(t.map(async t=>{const e=new n.Subscription;return this.keys.asyncMapTo(e=>new this.promiseCtr(r=>t[e].observable.subscribe(r)),this.promiseCtr).then(t=>({subscription:e,entity:t}))}))}_status(t,e){return null===t?null:null!=t?t:e}_populate(t){const e=t.map(t=>this.keys.mapTo(e=>this.stores[e].get(this.keyof(e,t[e])))),r=this.toPromise(e);return this.keys.keys.forEach(e=>this.stores[e].nextBulk(t.map(t=>({id:this.keyof(e,t[e]),data:t[e]})))),r}reload(t){return this.exec(0,t)}more(t){return this.exec(1,t)}_setDone(t,e,r){if(null===r)return e[0]=this.promiseCtr.resolve(!0),!1;if(t>0){const r=this.donePromises[t-1];if(r)return e[0]=r,!1}return!0}exec(t,e,r,n){return this.donePromises[t]||(this.donePromises[t]=this._exec(t,e,r,n))}}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0})},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Store=void 0;const n=r(0),i=r(10);e.Store=class{constructor(t,e,r,i=null){this.name=t,this.finalize=e,this.promiseCtr=r,this.parent=i,this._items=new Map,this.insersions=new n.Subject,this.emptyInsersions=new n.Subject}rewind(t){var e;const r=this._items.get(t);null===(e=i.getEntity(null==r?void 0:r.entity))||void 0===e||e.rewind()}prepare(t,e){const r=this.get(t);return new n.Observable(n=>{const i=r.observable.subscribe(n),s=this._items.get(t);if(!s)return;return(s.next=(s.next||{then:(t,e)=>{try{return this.promiseCtr.resolve(e())}catch(t){return this.promiseCtr.reject(t)}}}).then(void 0,()=>{const t=s;if(!s.closed&&!s.ready)return e(s.id,{get ready(){return t.ready}},t=>i.add(t))})).then(void 0,()=>{}),i})}nextBulk(t){const e=t.filter(({id:t,data:e})=>this._next(t,e)).map(({id:t})=>t);this.insersions.next(e)}next(t,e){this._next(t,e)&&this.insersions.next([t])}_next(t,e){const r=this._items.get(t);if(r){if(r.entity)return i.$update(r.entity,e),r.ready=!0,!1;{if(this.parent){const n=this.parent.get(t);r.entity=i.toEntity(new i.ChildEntityImpl({data:e,ready:!1,parentPromise:{then:t=>{var e;const i=n.observable.subscribe(e=>t(e));null===(e=r.parentSubscription)||void 0===e||e.unsubscribe(),r.parentSubscription=i}}}))}else r.entity=i.toEntity(new i.EntityImpl(e));const n=r.entity;return r.ready=!0,r.observers.forEach(t=>t.next(n)),!0}}}updateId(t,e){var r,n;if(this._items.get(e))throw new Error('New Id "'+e+'" is taken');const s=this._items.get(t);if(s&&(s.id=e,this._items.delete(t),this._items.set(e,s),null===(r=i.getEntity(s.entity))||void 0===r||r.setParent(),null===(n=s.parentSubscription)||void 0===n||n.unsubscribe(),this.parent)){const t=this.parent.get(e);if(s.entity instanceof i.ChildEntityImpl){const e=s.entity;s.parentSubscription=t.observable.subscribe(t=>{e.setParent(t)})}}}update(t,e){var r,n;null===(n=i.getEntity(null===(r=this._items.get(t))||void 0===r?void 0:r.entity))||void 0===n||n.update(e)}item(t,e){let r=this._items.get(t);return r?r.observers.push(e):this._items.set(t,r={id:t,observers:[e]}),r}get(t,e){return i.entityFlow(new n.Observable(r=>{const n=this.item(t,r),s=n.observers;if(n.entity)e||r.next(n.entity);else if(this.parent&&!n.parentSubscription){let r=!e;n.parentSubscription=this.parent.get(t).observable.subscribe(t=>{n.entity=i.toEntity(new i.ChildEntityImpl({data:{},parent:t,ready:!0})),this.emptyInsersions.next(n.id),r&&s.forEach(t=>t.next(n.entity))}),r=!0}return()=>{const t=n.id,e=s.indexOf(r);if(-1!==e&&s.splice(e,1),!s.length){const e=n.parentSubscription;this._items.delete(t),n.closed=!0,n.entity&&this.finalize(t,n.entity),e&&e.unsubscribe()}}}))}}}])}));